= Dev Ops on Cloud Foundry Platform

== Goals

To deploy and configure a microservice and UI, leverage the platform for monitoring & management of the microservice, and automate a continuous delivery pipeline.

== Pre-work

1. Fork link:https://github.com/rjain-pivotal/pcf-workshop-workspace/[`PCF Workshop Workspace`]  
2. Review the link:https://github.com/pcf-alliances-immersion/pcf-immersion-workspace/tree/master/cities[overview] of the `cities` repository.  
3. Review the documentation on link:http://docs.pivotal.io/pivotalcf/devguide/deploy-apps/prepare-to-deploy.html[Considerations for Designing and Running an Application in the Cloud]
4. Review the documentation on link:http://docs.pivotal.io/pivotalcf/devguide/deploy-apps/streaming-logs.html#writing[Writing to logs]

== Steps
In this workshop we are going to follow these steps to deploy apps on Cloud foundry and manage the lifecycle
image:blue-green.png[Blue Green Deployment]

=== Building apps
To build the app go to the workspace folder
[source,perl]
cd pcf-workshop-workspace/cities
gradle build

=== Pushing the cities-service app using CLI
[source,bash]
cd pcf-workshop-workspace/cities/cities-service/build/libs



Use `cf help` and/or `cf <command> --help` for details on each of the commands below.

. Review the docs: http://docs.pivotal.io/pivotalcf/devguide/deploy-apps/deploy-app.html

. Verify you are logged in with your own userid (*not admin*) and targeted to your PCF instance:
+
[source,bash]
----
$ cf target
----

. Push the cities-service:
+
[source,bash]
----
$ cf push cities-service -i 1 -m 512M -p cities-service-0.0.1-SNAPSHOT.jar
----
+
* Be sure to name your application '<first-initial><last-initial>-cities-service'

. Verify you can access your application via a curl request:
+
[source,bash]
----
$ curl -i cities-service/cities
----


=== Using Manifests to Push the cities-ui app

Next, push the cities-ui app
Now, use a manifest to help automate deployment.

. Review the documentation: http://docs.pivotal.io/pivotalcf/devguide/deploy-apps/manifest.html

. Create an application manifest in your `cities-service` directory called `manifest.yml`.  Minimally, you must set the name of the app, the amount of memory, the number of instances, and the path to the .jar file.
+
*Be sure to name your application '<first-initial><last-initial>-cities-service' and use this as the host value.*
+
We must be able to access your application at https://<first-initial><last-initial>-cities-service.YOUR_PCF_APP_DOMAIN

. The IBM Bluemix team has created a manifest generator app that can also be used:
+
* Hosted: http://cfmanigen.mybluemix.net/
* Source: https://github.com/IBM-Bluemix/cf-manifest-generator
+

. Test your manifest by re-pushing your app with no parameters:
+
[source,bash]
----
$ cf push
----

=== Dependency Injection in Spring

 Bind to in memory database

=== Health, logging & events via the CLI

 View recent logs using CLI

=== Binding to services

 Bind Cities Services to MySQL
 Bind Cities UI to Cities Services

=== Environment variables

 View the environment variable and explantion of VCAP

=== Scaling apps

 Scale the App using Ops Manager

=== Verify the app from the Console

=== Create Version 2

 Create Version 2 by changing the Version Number Env variable 

=== Push Version 2 and Delete the Old Route using the script
Create the following env variables

[source,bash]

DEPLOYED_VERSION_CMD=$(CF_COLOR=false cf apps | grep 'mapUS.' | cut -d" " -f1)
export BUILD_VERSION="1.2"
export DEPLOYED_VERSION_CMD
echo DEPLOYED_VERSION_CMD
export ROUTE_VERSION="default"
echo "Deployed Version: $DEPLOYED_VERSION"
echo "Route Version: $ROUTE_VERSION"
export API=http://<your_cf_api>

cf api --skip-ssl-validation $API
cf login -u <user> -p <password> -o <org> -s <space>

cf create-service p-rabbitmq standard demo-rabbit

cf push PCFDemo-producer -f PCFDemo-producer/manifest.yml --no-start
cf push PCFDemo-map -f PCFDemo-map/manifest.yml --no-start

cf bind-service PCFDemo-producer demo-rabbit
cf bind-service PCFDemo-map demo-rabbit

cf restart PCFDemo-producer
cf restart PCFDemo-map


=== Verify the app, zero downtime
